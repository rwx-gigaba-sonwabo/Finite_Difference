Option Explicit

'==============================
' Helpers
'==============================
Private Function FirstOfMonth(ByVal d As Date) As Date
    FirstOfMonth = DateSerial(Year(d), Month(d), 1)
End Function

Private Function ShiftMonths(ByVal d As Date, ByVal months As Long) As Date
    ShiftMonths = DateSerial(Year(d), Month(d) + months, 1)
End Function

Private Function DaysInMonthCount(ByVal d As Date) As Long
    ' Day of the 0th day of next month = last day of current month
    DaysInMonthCount = Day(DateSerial(Year(d), Month(d) + 1, 0))
End Function

Private Function LookupCPI(ByVal firstOfMonthDate As Date) As Variant
    On Error GoTo ErrHandler

    Dim lo As ListObject
    Dim rngDates As Range, rngVals As Range
    Dim idx As Variant

    With ThisWorkbook.Worksheets("Historical_CPI_Values")
        Set lo = .ListObjects("CPI_Index")
        Set rngDates = lo.ListColumns(1).DataBodyRange
        Set rngVals = lo.ListColumns(2).DataBodyRange
    End With

    idx = Application.Match(CDbl(firstOfMonthDate), rngDates, 0)
    If IsError(idx) Then
        LookupCPI = CVErr(xlErrNA)
    Else
        LookupCPI = rngVals.Cells(CLng(idx), 1).Value
    End If
    Exit Function

ErrHandler:
    LookupCPI = CVErr(xlErrNA)
End Function

'==============================
' Main Published CPI Function
'==============================
Public Function PublishedCPI(ByVal inputDate As Date) As Variant
    Dim lag4 As Date, lag3 As Date
    Dim cpi4 As Variant, cpi3 As Variant
    Dim numDays As Long
    Dim fraction As Double

    ' 4-month lag from first of input month
    lag4 = ShiftMonths(FirstOfMonth(inputDate), -4)

    ' If exactly on first day: just return CPI of lag4 month
    If Day(inputDate) = 1 Then
        PublishedCPI = LookupCPI(lag4)
        Exit Function
    End If

    ' Otherwise interpolate toward 3-month lag month
    lag3 = ShiftMonths(lag4, 1)

    cpi4 = LookupCPI(lag4)
    If IsError(cpi4) Then
        PublishedCPI = cpi4
        Exit Function
    End If

    cpi3 = LookupCPI(lag3)
    If IsError(cpi3) Then
        PublishedCPI = cpi3
        Exit Function
    End If

    numDays = DaysInMonthCount(inputDate)
    fraction = (Day(inputDate) - 1) / numDays

    PublishedCPI = CDbl(cpi4) + fraction * (CDbl(cpi3) - CDbl(cpi4))
End Function
